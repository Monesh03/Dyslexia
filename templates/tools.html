{% extends "base.html" %}
{% block content %}
<style>
  /* Sidebar Styles */
  .sidebar {
    height: 100%;
    width: 250px;
    position: fixed;
    z-index: 1000;
    top: 0;
    left: -250px;
    background-color: #111;
    overflow-x: hidden;
    transition: 0.4s;
    padding-top: 60px;
    border-right: 2px solid #007bff;
  }

  .sidebar a {
    padding: 12px 20px;
    text-decoration: none;
    font-size: 17px;
    color: #f1f1f1;
    display: block;
    transition: 0.3s;
  }

  .sidebar a:hover {
    background-color: #007bff;
    color: white;
    border-radius: 4px;
  }

  /* Toggle Button */
  .openbtn {
    font-size: 18px;
    cursor: pointer;
    background-color: #007bff;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 5px;
    position: fixed;
    top: 15px;
    left: 15px;
    z-index: 1100;
  }

  .openbtn:hover {
    background-color: #0056b3;
  }

  /* Page content */
  #main {
    transition: margin-left 0.4s;
    padding: 20px;
    margin-left: 0;
  }

  /* Tab Buttons */
  .custom-nav {
    display: flex;
    justify-content: center;
    gap: 1rem;
    background-color: #222c31;
    padding: 1rem;
    border-radius: 10px;
  }

  .nav-btn {
    flex: 1;
    max-width: 250px;
    text-align: center;
    padding: 12px 20px;
    font-weight: 600;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    color: black;
    background-color: #6c6c6c;
    transition: all 0.3s ease;
  }

  .nav-btn.active {
    background-color: #f00d88;
    color: white;
  }

  .nav-btn:hover {
    opacity: 0.9;
  }

  /* Tab Content */
  .tab-content {
    display: none;
    background-color: #f8f9fa;
    padding: 1.5rem;
    border-radius: 10px;
    margin-top: 1rem;
  }

  .tab-content.active {
    display: block;
    animation: fadeIn 0.4s ease-in-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Voice input section */
  #spokenText {
    background-color: #fff;
    border: 1px solid #ccc;
  }

  #recordingStatus {
    font-weight: 600;
    color: #007bff;
  }

  /* Simplify output */
  .simplify-result {
    background-color: #eaf4ff;
    border-left: 5px solid #007bff;
    padding: 10px;
    border-radius: 5px;
  }

  /* Responsive */
  @media screen and (max-width: 768px) {
    .sidebar { width: 200px; }
    .openbtn { font-size: 16px; padding: 8px 12px; }
    .custom-nav { flex-direction: column; }
    .nav-btn { width: 100%; }
  }
</style>

<!-- Sidebar -->
<div id="mySidebar" class="sidebar">
  <a href="javascript:void(0)" onclick="closeNav()">‚ùå Close</a>
  <a href="#simplify">üß© Simplify Text</a>
  <a href="#reading">üéô Reading Practice</a>
  <a href="#more">üí° More Tools</a>
</div>

<!-- Main Page -->
<div id="main">
  <h3 class="mb-4">üìò Learning Tools</h3>

  <!-- Tab Navbar -->
  <div class="custom-nav">
    <button class="nav-btn active" onclick="setActive(this, 'simplify')">Simplify Text</button>
    <button class="nav-btn" onclick="setActive(this, 'reading')">Reading Practice</button>
    <button class="nav-btn" onclick="setActive(this, 'more')">More Tools</button>
  </div>

  <!-- üß© Simplify Text Section -->
  <div id="simplify" class="tab-content active">
    <form method="POST">
      <textarea name="text" class="form-control" rows="4" placeholder="Enter your complex text here..."></textarea>
      <button name="simplify" class="btn btn-primary mt-3">‚ú® Simplify Text</button>
    </form>

    {% if result %}
    <div class="simplify-result mt-3">
      <b>Simplified Text:</b><br>{{ result }}
    </div>
    {% endif %}
  </div>

  <!-- üéô Reading Practice Section -->
  <div id="reading" class="tab-content">
    <form id="targetForm" method="POST">
      <textarea id="targetText" name="text" class="form-control" rows="2" placeholder="Enter the sentence to read...">{{ text or '' }}</textarea>
    </form>

    <div class="mt-3">
      <button type="button" id="startBtn" class="btn btn-danger">üéô Start Reading</button>
      <span id="recordingStatus" class="ms-3 text-muted">Not listening...</span>
    </div>

    <textarea id="spokenText" class="form-control mt-3" rows="2" placeholder="Your spoken words will appear here..." readonly></textarea>

    <form method="POST" class="mt-3" id="feedbackForm">
      <input type="hidden" name="expected" id="expectedText">
      <input type="hidden" name="spoken" id="spokenHidden">
      <button type="submit" name="feedback" class="btn btn-success">üîÅ Get Feedback</button>
    </form>

    {% if feedback %}
    <div class="alert alert-warning mt-3">
      <h5>üó£ Feedback to Student:</h5>
      <p>{{ feedback|safe }}</p>
      <button class="btn btn-info mt-2" type="button" onclick="speakText('{{ text }}')">üîä Hear Correct Sentence</button>
    </div>
    {% endif %}
  </div>

  <!-- üí° More Tools Section -->
  <div id="more" class="tab-content">
    <p>Coming soon: Grammar check, summary generator, and pronunciation tools.</p>
  </div>
</div>

<!-- JavaScript -->
<script>
  // Sidebar toggle
  function openNav() {
    document.getElementById("mySidebar").style.left = "0";
    document.getElementById("main").style.marginLeft = "250px";
  }

  function closeNav() {
    document.getElementById("mySidebar").style.left = "-250px";
    document.getElementById("main").style.marginLeft = "0";
  }

  // Tab switching
  function setActive(button, tabId) {
    document.querySelectorAll(".nav-btn").forEach(btn => btn.classList.remove("active"));
    button.classList.add("active");
    document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("active"));
    document.getElementById(tabId).classList.add("active");
  }

  // üéô Speech Recognition
  let recognition;
  const startBtn = document.getElementById('startBtn');
  const spokenText = document.getElementById('spokenText');
  const recordingStatus = document.getElementById('recordingStatus');
  const expectedText = document.getElementById('expectedText');
  const spokenHidden = document.getElementById('spokenHidden');

  if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.lang = 'en-US';
    recognition.continuous = false;
    recognition.interimResults = false;

    startBtn.addEventListener('click', () => {
      spokenText.value = "";
      recordingStatus.textContent = "üéß Listening...";
      recognition.start();
    });

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      spokenText.value = transcript;
      spokenHidden.value = transcript;
      expectedText.value = document.getElementById('targetText').value;
      recordingStatus.textContent = "‚úÖ Speech captured!";
    };

    recognition.onerror = () => {
      recordingStatus.textContent = "‚ùå Error capturing voice.";
    };
  } else {
    recordingStatus.textContent = "Voice recognition not supported on this browser.";
  }

  // üó£ Speak the correct sentence aloud
  function speakText(text) {
    if (!('speechSynthesis' in window)) {
      alert("Sorry, your browser does not support speech synthesis.");
      return;
    }
    const synth = window.speechSynthesis;
    const utter = new SpeechSynthesisUtterance(text);
    utter.rate = 0.9;
    utter.pitch = 1.0;
    utter.volume = 1.0;
    utter.lang = 'en-US';
    synth.cancel();
    setTimeout(() => synth.speak(utter), 300);
  }
</script>
{% endblock %}
