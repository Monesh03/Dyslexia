{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <div class="tools-header text-center mb-4">
    <h2 class="mb-2">Learning Tools</h2>
    <p class="text-muted">Interactive tools to support your learning journey</p>
  </div>

  <ul class="nav nav-pills nav-fill mb-4 tools-nav" id="toolsTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="simplify-tab" data-bs-toggle="pill" data-bs-target="#simplify" type="button" role="tab">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" class="me-2">
          <path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/>
        </svg>
        Simplify Text
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="reading-tab" data-bs-toggle="pill" data-bs-target="#reading" type="button" role="tab">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" class="me-2">
          <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/>
          <path d="M10 8a2 2 0 1 1-4 0V3a2 2 0 1 1 4 0v5zM8 0a3 3 0 0 0-3 3v5a3 3 0 0 0 6 0V3a3 3 0 0 0-3-3z"/>
        </svg>
        Reading Practice
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="more-tab" data-bs-toggle="pill" data-bs-target="#more" type="button" role="tab">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" class="me-2">
          <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
          <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319z"/>
        </svg>
        More Tools
      </button>
    </li>
  </ul>

  <div class="tab-content" id="toolsTabContent">

    <div class="tab-pane fade show active" id="simplify" role="tabpanel">
      <div class="tool-card">
        <h4 class="mb-3">Text Simplifier</h4>
        <p class="text-muted mb-4">Enter complex text and get an easier-to-read version</p>

        <form method="POST">
          <div class="mb-3">
            <label class="form-label fw-semibold">Complex Text</label>
            <textarea name="text" class="form-control form-control-lg" rows="5" placeholder="Paste or type your complex text here..." required></textarea>
          </div>
          <button name="simplify" class="btn btn-primary btn-lg">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" class="me-2">
              <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
              <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
            </svg>
            Simplify Text
          </button>
        </form>

        {% if result %}
        <div class="result-box mt-4">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Simplified Text</h5>
            <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('{{ result }}')">Copy</button>
          </div>
          <p class="simplified-text">{{ result }}</p>
        </div>
        {% endif %}
      </div>
    </div>

    <div class="tab-pane fade" id="reading" role="tabpanel">
      <div class="tool-card">
        <h4 class="mb-3">Reading Practice</h4>
        <p class="text-muted mb-4">Practice reading aloud and get instant feedback</p>

        <form id="targetForm" method="POST">
          <div class="mb-3">
            <label class="form-label fw-semibold">Sentence to Practice</label>
            <textarea id="targetText" name="text" class="form-control" rows="2" placeholder="Enter or paste the sentence you want to practice reading...">{{ text or '' }}</textarea>
          </div>
        </form>

        <div class="recording-section mb-3">
          <button type="button" id="startBtn" class="btn btn-danger btn-lg">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" class="me-2">
              <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/>
              <path d="M10 8a2 2 0 1 1-4 0V3a2 2 0 1 1 4 0v5zM8 0a3 3 0 0 0-3 3v5a3 3 0 0 0 6 0V3a3 3 0 0 0-3-3z"/>
            </svg>
            Start Recording
          </button>
          <span id="recordingStatus" class="ms-3 fw-semibold text-muted">Ready to record</span>
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">Your Spoken Words</label>
          <textarea id="spokenText" class="form-control" rows="2" placeholder="Your spoken words will appear here..." readonly></textarea>
        </div>

        <form method="POST" id="feedbackForm">
          <input type="hidden" name="expected" id="expectedText">
          <input type="hidden" name="spoken" id="spokenHidden">
          <button type="submit" name="feedback" class="btn btn-success btn-lg">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" class="me-2">
              <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
            </svg>
            Get Feedback
          </button>
        </form>

        {% if feedback %}
        <div class="feedback-box mt-4">
          <h5 class="mb-3">Your Reading Feedback</h5>
          <div class="feedback-content">
            {{ feedback|safe }}
          </div>
          <button class="btn btn-info mt-3" type="button" onclick="speakText('{{ text }}')">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" class="me-2">
              <path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-.708.707A7.476 7.476 0 0 1 13.025 8c0 2.071-.84 3.946-2.197 5.303l.708.707z"/>
              <path d="M10.121 12.596A6.48 6.48 0 0 0 12.025 8a6.48 6.48 0 0 0-1.904-4.596l-.707.707A5.483 5.483 0 0 1 11.025 8a5.483 5.483 0 0 1-1.61 3.89l.706.706z"/>
              <path d="M8.707 11.182A4.486 4.486 0 0 0 10.025 8a4.486 4.486 0 0 0-1.318-3.182L8 5.525A3.489 3.489 0 0 1 9.025 8 3.49 3.49 0 0 1 8 10.475l.707.707zM6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06z"/>
            </svg>
            Listen to Correct Pronunciation
          </button>
        </div>
        {% endif %}
      </div>
    </div>

    <div class="tab-pane fade" id="more" role="tabpanel">
      <div class="tool-card text-center py-5">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="text-muted mb-3" viewBox="0 0 16 16">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
        </svg>
        <h4 class="mb-3">More Tools Coming Soon</h4>
        <p class="text-muted">We're working on additional features including:</p>
        <ul class="list-unstyled mt-3">
          <li class="mb-2">Grammar Checker</li>
          <li class="mb-2">Text Summarizer</li>
          <li class="mb-2">Pronunciation Guide</li>
          <li class="mb-2">Vocabulary Builder</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
      alert('Text copied to clipboard!');
    });
  }

  // Speech Recognition
  let recognition;
  const startBtn = document.getElementById('startBtn');
  const spokenText = document.getElementById('spokenText');
  const recordingStatus = document.getElementById('recordingStatus');
  const expectedText = document.getElementById('expectedText');
  const spokenHidden = document.getElementById('spokenHidden');

  if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.lang = 'en-US';
    recognition.continuous = false;
    recognition.interimResults = false;

    startBtn.addEventListener('click', () => {
      spokenText.value = "";
      recordingStatus.textContent = "Listening...";
      recordingStatus.classList.remove('text-muted');
      recordingStatus.classList.add('text-danger');
      recognition.start();
    });

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      spokenText.value = transcript;
      spokenHidden.value = transcript;
      expectedText.value = document.getElementById('targetText').value;
      recordingStatus.textContent = "Speech captured successfully!";
      recordingStatus.classList.remove('text-danger');
      recordingStatus.classList.add('text-success');
    };

    recognition.onerror = () => {
      recordingStatus.textContent = "Error capturing voice. Please try again.";
      recordingStatus.classList.remove('text-danger');
      recordingStatus.classList.add('text-warning');
    };
  } else {
    recordingStatus.textContent = "Voice recognition not supported on this browser.";
    recordingStatus.classList.add('text-warning');
    startBtn.disabled = true;
  }

  // Speak the correct sentence aloud
  function speakText(text) {
    if (!('speechSynthesis' in window)) {
      alert("Sorry, your browser does not support speech synthesis.");
      return;
    }
    const synth = window.speechSynthesis;
    const utter = new SpeechSynthesisUtterance(text);
    utter.rate = 0.9;
    utter.pitch = 1.0;
    utter.volume = 1.0;
    utter.lang = 'en-US';
    synth.cancel();
    setTimeout(() => synth.speak(utter), 300);
  }
</script>
{% endblock %}
